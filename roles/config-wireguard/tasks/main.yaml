---
- name: Setup WireGuard tunnels for nodes
  ansible.builtin.include_tasks:
    file: node.yaml

- name: Setup WireGuard tunnels for DN42 peers
  ansible.builtin.include_tasks:
    file: dn42.yaml
  when: inventory_hostname in groups.get(dn42_group, [])

- name: Restart WireGuard services when configuration changes
  ansible.builtin.systemd:
    name: "wg-quick@{{ item.peer.interface_name }}"
    state: restarted
  loop: "{{ wg_rendered_peers | default([]) }}"
  loop_control:
    label: "{{ item.peer.interface_name }}"
  when:
    - wg_rendered_peers is defined
    - item.changed

- name: Ensure wg-quick services are enabled and started
  ansible.builtin.systemd:
    name: "wg-quick@{{ item.peer.interface_name }}"
    enabled: true
    daemon_reload: true
  loop: "{{ wg_rendered_peers | default([]) }}"
  loop_control:
    label: "{{ item.peer.interface_name }}"

- name: Ensure wg-quick services are running
  ansible.builtin.systemd:
    name: "wg-quick@{{ item.peer.interface_name }}"
    state: started
  loop: "{{ wg_rendered_peers | default([]) }}"
  loop_control:
    label: "{{ item.peer.interface_name }}"
