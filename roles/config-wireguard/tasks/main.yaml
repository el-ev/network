---
- name: Gather WireGuard node list
  ansible.builtin.set_fact:
    wireguard_node_hosts: "{{ groups.get(wireguard_nodes_group, []) | list }}"

- name: Compute WireGuard ordering for this node
  ansible.builtin.set_fact:
    wireguard_self_order: "{{ wireguard_node_hosts.index(inventory_hostname) + 1 }}"

- name: Build WireGuard peer descriptors
  ansible.builtin.set_fact:
    wireguard_peer_map: "{{ (wireguard_peer_map | default([])) + [peer_entry] }}"
  vars:
    peer_hostvars: "{{ hostvars[peer] | default({}) }}"
    peer_public_key: >-
      {{ peer_hostvars.peer.wg_pubkey
         if peer_hostvars.peer is defined and peer_hostvars.peer.wg_pubkey is defined
         else (peer_hostvars.wg_pubkey if peer_hostvars.wg_pubkey is defined else '') }}
    peer_entry:
      name: "{{ peer }}"
      interface_name: "{{ wireguard_interface_prefix }}{{ peer | replace('-', '_') }}"
      peer_order: "{{ wireguard_node_hosts.index(peer) + 1 }}"
      endpoint_host: "{{ peer_hostvars.ansible_host | default(peer) }}"
      public_key: "{{ peer_public_key }}"
  loop: "{{ wireguard_node_hosts }}"
  loop_control:
    loop_var: peer
  when: peer != inventory_hostname

- name: Read WireGuard private key
  ansible.builtin.slurp:
    src: "{{ wireguard_private_key_path }}"
  register: wireguard_private_key_raw
  no_log: true

- name: Cache WireGuard private key content
  ansible.builtin.set_fact:
    wireguard_private_key: "{{ wireguard_private_key_raw.content | b64decode | trim }}"
  no_log: true

- name: Render per-peer WireGuard configurations
  ansible.builtin.template:
    src: node_tunnel.conf.j2
    dest: "/etc/wireguard/{{ peer.interface_name }}.conf"
    owner: root
    group: root
    mode: '0600'
  loop: "{{ wireguard_peer_map | default([]) }}"
  loop_control:
    loop_var: peer
    label: "{{ peer.name }}"
  register: wireguard_peer_templates
  when: (wireguard_peer_map | default([])) | length > 0
  no_log: true

- name: Restart WireGuard services when configuration changes
  ansible.builtin.systemd:
    name: "wg-quick@{{ item.peer.interface_name }}"
    state: restarted
  loop: "{{ wireguard_peer_templates.results | default([]) }}"
  when:
    - wireguard_peer_templates is defined
    - item.changed

- name: Ensure wg-quick services are enabled
  ansible.builtin.systemd:
    name: "wg-quick@{{ peer.interface_name }}"
    enabled: true
    daemon_reload: true
  loop: "{{ wireguard_peer_map | default([]) }}"
  loop_control:
    loop_var: peer

- name: Ensure wg-quick services are running
  ansible.builtin.systemd:
    name: "wg-quick@{{ peer.interface_name }}"
    state: started
  loop: "{{ wireguard_peer_map | default([]) }}"
  loop_control:
    loop_var: peer
