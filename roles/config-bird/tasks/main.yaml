---
- name: Gather node list
  ansible.builtin.set_fact:
    node_hosts: "{{ groups.get(node_group, []) | list }}"

- name: Gather dn42 node list
  ansible.builtin.set_fact:
    node_hosts: "{{ groups.get(dn42_group, []) | list }}"

- name: Setup sysctl for DN42
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/60-dn42.conf
    reload: true
  loop:
    - { name: 'net.ipv4.conf.default.rp_filter', value: '0' }
    - { name: 'net.ipv4.conf.all.rp_filter', value: '0' }
    - { name: 'net.ipv4.ip_forward', value: '1' }
    - { name: 'net.ipv6.conf.all.forwarding', value: '1' }

- name: Setup DN42 workspace
  ansible.builtin.file:
    path: "{{ automation_root_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create automation account for dn42 scripts
  ansible.builtin.user:
    name: "{{ automation_user }}"
    group: nogroup
    groups: bird
    system: true
    password: "!"
    home: "{{ automation_user_home }}"

- name: Copy dn42 dummy interface config
  ansible.builtin.template:
    src: dn42-interface.j2
    dest: /etc/network/interfaces.d/60-dn42-dummy
    owner: root
    group: root
    mode: '0644'

- name: Ensure dn42-dummy interface is up
  ansible.builtin.shell: |
    ifdown dn42-dummy || true
    ifup dn42-dummy
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false

- name: Setup ROA script
  block:
    - name: Copy ROA update script
      ansible.builtin.copy:
        src: update-dn42-roas.sh
        dest: /opt/dn42/update-dn42-roas.sh
        owner: root
        group: root
        mode: '0755'

    - name: Setup cron job for ROA updates
      ansible.builtin.cron:
        name: "Update DN42 ROAs"
        minute: "15"
        hour: "*"
        job: "{{ automation_root_dir }}/update-dn42-roas.sh"
        user: bird

    - name: Run ROA update script once if not exists
      ansible.builtin.command: "{{ automation_root_dir }}/update-dn42-roas.sh"
      become: true
      become_user: bird
      failed_when: false
      args:
        creates: /etc/bird/roa_dn42.conf
      when: not ansible_check_mode
      changed_when: false

- name: Create /etc/bird/nodes directory
  ansible.builtin.file:
    path: /etc/bird/nodes
    state: directory
    owner: bird
    group: bird
    mode: '0755'

- name: Create /etc/bird/peers directory
  ansible.builtin.file:
    path: /etc/bird/peers
    state: directory
    owner: bird
    group: bird
    mode: '0755'

- name: Ensure BIRD service is running
  ansible.builtin.service:
    name: bird
    state: started
    enabled: true

- name: Render node-specific configuration
  ansible.builtin.template:
    src: node.conf.j2
    dest: /etc/bird/node.conf
    owner: bird
    group: bird
    mode: '0644'

- name: Copy babel configuration
  ansible.builtin.copy:
    src: babel.conf
    dest: /etc/bird/babel.conf
    owner: bird
    group: bird
    mode: '0644'

- name: Copy BIRD main configuration
  ansible.builtin.copy:
    src: bird.conf
    dest: /etc/bird/bird.conf
    owner: bird
    group: bird
    mode: '0644'
    validate: bird -p -c %s
  notify: Reload BIRD configuration

- name: Render per-node BIRD configurations
  ansible.builtin.template:
    src: node_peer.conf.j2
    dest: "/etc/bird/nodes/{{ node_prefix }}{{ peer | replace('-', '_') }}.conf"
    owner: bird
    group: bird
    mode: '0644'
  loop: "{{ node_hosts }}"
  loop_control:
    loop_var: peer
    label: "{{ peer }}"
  when: peer != inventory_hostname

- name: Render DN42 peer configurations
  ansible.builtin.template:
    src: dn42_peer.conf.j2
    dest: "/etc/bird/peers/{{ dn42_prefix }}{{ (item.bgp.asn | string)[-4:] }}.conf"
    owner: bird
    group: bird
    mode: '0644'
  loop: "{{ lookup('vars', inventory_hostname).peers | default([]) }}"
  when: lookup('vars', inventory_hostname) is defined and lookup('vars', inventory_hostname).peers is defined
  notify: Reload BIRD configuration
