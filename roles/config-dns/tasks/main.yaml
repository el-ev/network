---
- name: Install BIND9
  ansible.builtin.apt:
    name: "{{ dns_service.packages }}"
    state: present
    update_cache: true

- name: Ensure zone directory exists
  ansible.builtin.file:
    path: "{{ dns_service.zone_dir }}"
    state: directory
    owner: "{{ dns_service.user }}"
    group: "{{ dns_service.group }}"
    mode: '0755'

- name: Gather DNS binding settings for host
  ansible.builtin.set_fact:
    dns_host_binding: "{{ dns_nameserver_bindings.get(inventory_hostname, {}) }}"

- name: Merge host-specific DNS listen addresses
  ansible.builtin.set_fact:
    dns_named_options_rendered: >-
      {{ dns_named_options | combine(
          {
            'listen_on_v4': (dns_named_options.listen_on_v4 | default([])) + (dns_host_binding.listen_on_v4 | default([])),
            'listen_on_v6': (dns_named_options.listen_on_v6 | default([])) + (dns_host_binding.listen_on_v6 | default([]))
          },
          recursive=True
        )
      }}

- name: Run prologue setup
  ansible.builtin.include_tasks:
    file: prologue.yaml
  when: target is undefined
