---
- name: Install BIND9
  ansible.builtin.apt:
    name: "{{ dns_service.packages }}"
    state: present
    update_cache: true

- name: Ensure zone directory exists
  ansible.builtin.file:
    path: "{{ dns_service.zone_dir }}"
    state: directory
    owner: "{{ dns_service.user }}"
    group: "{{ dns_service.group }}"
    mode: '0755'

- name: Gather DNS binding settings for host
  ansible.builtin.set_fact:
    dns_host_binding: "{{ dns_nameserver_bindings.get(inventory_hostname, {}) }}"

- name: Merge host-specific DNS listen addresses
  ansible.builtin.set_fact:
    dns_named_options_rendered: >-
      {{ dns_named_options | combine(
          {
            'listen_on_v4': (dns_named_options.listen_on_v4 | default([])) + (dns_host_binding.listen_on_v4 | default([])),
            'listen_on_v6': (dns_named_options.listen_on_v6 | default([])) + (dns_host_binding.listen_on_v6 | default([]))
          },
          recursive=True
        )
      }}

- name: Render named.conf.options
  ansible.builtin.template:
    src: named.conf.options.j2
    dest: "{{ dns_service.config_dir }}/named.conf.options"
    owner: root
    group: "{{ dns_service.group }}"
    mode: '0644'
  notify: Restart bind9

- name: Render named.conf.local
  ansible.builtin.template:
    src: named.conf.local.j2
    dest: "{{ dns_service.config_dir }}/named.conf.local"
    owner: root
    group: "{{ dns_service.group }}"
    mode: '0644'
  notify: Restart bind9

- name: Render DNS zone files
  ansible.builtin.template:
    src: zone.db.j2
    dest: "{{ dns_service.zone_dir }}/{{ zone.file }}"
    owner: "{{ dns_service.user }}"
    group: "{{ dns_service.group }}"
    mode: '0644'
  loop: "{{ dns_zones | selectattr('type', 'equalto', 'master') | list }}"
  loop_control:
    label: "{{ zone.name }}"
    loop_var: zone
  notify: Restart bind9

- name: Ensure BIND is enabled and started
  ansible.builtin.service:
    name: "{{ dns_service.service_name }}"
    state: started
    enabled: true

- name: Disable systemd-resolved (if present)
  ansible.builtin.service:
    name: systemd-resolved
    state: stopped
    enabled: false
  ignore_errors: true
  failed_when: false

- name: Remove immutable flag from resolv.conf (if present)
  ansible.builtin.file:
    path: /etc/resolv.conf
    attributes: -i
  ignore_errors: true

- name: Remove existing resolv.conf
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: absent

- name: Point system DNS to local BIND instance
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    content: |
      # Managed by Ansible
      nameserver 127.0.0.1
      nameserver ::1
      search iris.dn42 dn42
      options timeout:2
    owner: root
    group: root
    mode: '0644'

- name: Lock resolv.conf
  ansible.builtin.file:
    path: /etc/resolv.conf
    attributes: +i
