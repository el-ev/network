{%- set first_listen_addr = lg_proxy_listen[0] if lg_proxy_listen is iterable and lg_proxy_listen is not string else lg_proxy_listen -%}
{%- set listen_port = first_listen_addr.split(':')[-1] -%}
{%- set shared_secret = lg_server_shared_secret | mandatory -%}
{%- set nodes = namespace(items=[]) -%}

{%- for lg_proxy in groups.get('dn42', []) -%}
{%-   set host_entry = hostvars[lg_proxy] | default({}) -%}
{%-   set hostname = host_entry.ansible_host | default(lg_proxy) -%}
{%-   set nodes.items = nodes.items + [{
    "name": lg_proxy,
    "url": "http://%s:%s" % (hostname, listen_port),
    "shared_secret": shared_secret
    }] -%}
{%- endfor -%}

{%- set config = {
    "listen": lg_server_listen | mandatory,
    "network": {
    "name": network_name | mandatory,
    "asn": asn | mandatory,
    "comment": network_comment | default(None)
    },
    "nodes": nodes.items,
} -%}

{%- if lg_server_poll_idle_timeout is defined -%}
{%-   set config = config | combine({"poll_idle_timeout": lg_server_poll_idle_timeout}) -%}
{%- endif -%}

{{ config | to_nice_json }}
